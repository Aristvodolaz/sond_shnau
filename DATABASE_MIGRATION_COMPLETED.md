# Миграция на PostgreSQL завершена

## Что было сделано

### 1. Создание API endpoints для всех сущностей

Созданы API endpoints для работы с базой данных PostgreSQL:

#### Dogs (Собаки)
- `GET /api/dogs` - получить список всех собак
- `GET /api/dogs/[slug]` - получить собаку по slug
- `GET /api/admin/dogs` - (admin) получить список собак
- `POST /api/admin/dogs` - (admin) создать собаку
- `PUT /api/admin/dogs/[id]` - (admin) обновить собаку
- `DELETE /api/admin/dogs/[id]` - (admin) удалить собаку

#### News (Новости)
- `GET /api/news` - получить список опубликованных новостей
- `GET /api/news/[slug]` - получить новость по slug
- `GET /api/admin/news` - (admin) получить все новости
- `POST /api/admin/news` - (admin) создать новость
- `PUT /api/admin/news/[id]` - (admin) обновить новость
- `DELETE /api/admin/news/[id]` - (admin) удалить новость

#### Stories (Счастливые истории)
- `GET /api/stories` - получить список историй
- `GET /api/stories/[slug]` - получить историю по slug
- `GET /api/admin/stories` - (admin) получить все истории
- `POST /api/admin/stories` - (admin) создать историю
- `PUT /api/admin/stories/[id]` - (admin) обновить историю
- `DELETE /api/admin/stories/[id]` - (admin) удалить историю

#### Adopted (Пристроенные)
- `GET /api/adopted` - получить список пристроенных собак

#### Memorial (В памяти)
- `GET /api/memorial` - получить список записей памяти

### 2. Обновление всех страниц

Все страницы теперь получают данные из PostgreSQL через API:

**Обновленные страницы:**
- `pages/index.vue` - главная страница (собаки и новости)
- `pages/dogs/[slug].vue` - детальная страница собаки
- `pages/news/[slug].vue` - детальная страница новости
- `pages/stories/[slug].vue` - детальная страница истории
- `pages/results/adopted.vue` - архив пристроенных собак
- `pages/results/stories.vue` - список счастливых историй
- `pages/results/memorial.vue` - страница памяти

### 3. Обновление RSS генерации

RSS лента теперь генерируется из базы данных PostgreSQL:
- `server/routes/rss.xml.get.ts` - обновлен для использования БД

### 4. Исправление проблем с импортами

Все импорты Node.js модулей обновлены для использования `node:` префикса:
- `server/database/db.ts` - использует `node:fs/promises`, `node:path`, `node:fs`
- `server/utils/auth.ts` - использует `node:crypto`

### 5. Функциональность миграции данных

Функция `migrateFromJSON()` в `server/database/db.ts` импортирует данные из JSON файлов в PostgreSQL.

## Как использовать

### Первоначальная настройка базы данных

1. Перейдите по адресу: `http://localhost:3001/setup`
2. Нажмите кнопку "Initialize Database"
3. Это создаст:
   - Все необходимые таблицы
   - Мигрирует данные из JSON файлов
   - Создаст пользователя admin (username: `admin`, password: `admin123`)

### Вход в админ-панель

1. Перейдите: `http://localhost:3001/admin/login`
2. Введите:
   - Username: `admin`
   - Password: `admin123`
3. После входа вы попадете в админ-панель

### Админ-панель

После входа доступны страницы:
- `/admin` - управление собаками
- `/admin/news` - управление новостями

## Структура базы данных

### Таблицы

1. **users** - пользователи админ-панели
2. **dogs** - собаки на пристройство
3. **news** - новости фонда
4. **stories** - счастливые истории
5. **memorial** - записи памяти
6. **adopted** - архив пристроенных собак
7. **sessions** - сессии пользователей

## Важные замечания

### Для продакшена

1. **Обязательно смените пароль администратора!**
   - Текущий пароль по умолчанию: `admin123`
   
2. **Обновите строку подключения к БД** в `server/database/config.ts`:
   ```typescript
   export const PG_CONFIG = {
     host: '155.212.216.148',
     port: 5432,
     user: 'my_user',
     password: '123456',
     database: 'fond_shnau'
   }
   ```

3. **Замените хеширование паролей**:
   - Сейчас используется простой SHA-256
   - Для продакшена установите `bcrypt` и обновите `server/utils/auth.ts`

4. **Настройте SSL** для PostgreSQL в продакшене

5. **Обновите домен** в `server/routes/rss.xml.get.ts`:
   ```typescript
   const siteUrl = 'https://ваш-домен.ru'
   ```

## Что дальше?

### JSON файлы

Файлы в папке `data/` теперь используются только для первоначальной миграции данных. После миграции все данные хранятся и управляются через PostgreSQL.

Вы можете:
- Оставить их как резервную копию
- Удалить после успешной миграции
- Использовать для тестирования локально

### Расширение админ-панели

Вы можете добавить управление для:
- Stories (счастливые истории)
- Memorial (записи памяти)
- Adopted (пристроенные собаки)

API endpoints уже созданы для stories, нужно только добавить UI страницы в админ-панели.

## Устранение проблем

### База данных не инициализируется

1. Проверьте подключение к PostgreSQL
2. Убедитесь, что база данных `fond_shnau` существует
3. Проверьте права пользователя `my_user`

### Ошибки импорта данных

1. Убедитесь, что JSON файлы существуют в папке `data/`
2. Проверьте формат данных в JSON файлах
3. Посмотрите логи в консоли для деталей

### Не работает админ-панель

1. Убедитесь, что база инициализирована
2. Проверьте, что пользователь admin создан
3. Попробуйте очистить cookies браузера

## Технический стек

- **База данных**: PostgreSQL 14+
- **ORM**: node-postgres (pg)
- **Аутентификация**: Session-based с cookies
- **Хеширование**: SHA-256 (demo), рекомендуется bcrypt для продакшена
